#!/usr/bin/env bash
# my-dotfiles | Copyright (C) 2025 eth-p
# Repository: https://github.com/eth-p/my-dotfiles
#
# Apply any local changes made to my-dotfiles or the
# device-specific configuration file.
# ==============================================================================
# shellcheck shell=bash source-path=../../
set -euo pipefail
cd "$(dirname "$(realpath "${BASH_SOURCE[0]}")")/../.."
# ==============================================================================
source "management/lib/nix.sh"

BOOTSTRAPPED_FLAKE_DIR="${BOOTSTRAPPED_FLAKE_DIR?Required}"

# ------------------------------------------------------------------------------

git() {
	nixpkgs_run git "$@"
}

# Ensure my-dotfiles repo is not dirty.
git diff --quiet --ignore-submodules HEAD || {
	show_error "error: my-dotfiles repo is dirty, cannot update flake lockfile."
	exit 1
}

# Update repo.
if ! pull_message=$(git pull --ff-only 2>&1); then
	show_error "error: failed to pull my-dotfiles repo."
	echo "$pull_message"
	exit 1
fi

# Update lock file.
nix flake update my-dotfiles \
	--flake "path:${BOOTSTRAPPED_FLAKE_DIR}" \
	--commit-lock-file \
	--quiet

# Instruct user.
show_notice "Run 'my-dotfiles apply' to apply the upgrade."
